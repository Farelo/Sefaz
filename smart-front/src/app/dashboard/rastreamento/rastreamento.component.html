<div class="row no-gutters m-container">
  <!-- Filtros -->
  <div class="col-sm-12 col-md-3 m-filtros">
    <p>Filtros:</p>
    <section>
      <div class="form-group">
        <label>Fornecedor</label>
        <ng-select [ngModel]="plantSearch" (change)="onChange($event)" [items]="plants" bindLabel="plant_name" placeholder="Escolha uma Planta">
          <ng-template ng-label-tmp let-item="item">
            {{item.plant_name}}
          </ng-template>
          <ng-template ng-option-tmp let-item="item">
            <div>
              {{item.plant_name}}
            </div>
          </ng-template>
        </ng-select>
      </div>

      <div class="form-group">
        <label for="selectCode">Embalagem</label>
        <ng-select id="selectCode" [(ngModel)]="selectedCode" (clear)="onClear()" (change)="loadSerialsOfSelectedEquipment()" [items]="codes"
          bindLabel="packing" placeholder="Selecione um Equipamento">
          <ng-template ng-label-tmp let-item="item">
            {{item.packing}}
          </ng-template>
          <ng-template ng-option-tmp let-item="item">
            <div>

              <b>Embalagem:</b> {{item.packing}}
            </div>
            <div>
              <small>
                <b>Fornecedor:</b> {{item.supplier.name}}
              </small>

            </div>
            <div>
              <small>
                <b> Projeto:</b> {{item.project.name}}
              </small>
            </div>


          </ng-template>
        </ng-select>
      </div>

      <div class="form-group">
        <label>Serial</label>
        <ng-select [(ngModel)]="selectedSerial" (clear)="permanenceInventory()" (change)="permanenceInventorySerial()" [items]="serials"
          bindLabel="serial" bindValue="serial" placeholder="Selecione um Serial" [disabled]="!selectedCode">
          <ng-template ng-label-tmp let-item="item">
            {{item.serial}}
          </ng-template>
          <ng-template ng-option-tmp let-item="item">
            <div>
              <small>
                <b>Serial:</b> {{item.serial}}</small>
            </div>
          </ng-template>
        </ng-select>
      </div>
    </section>

    <p style="margin-top: 40px">Exibição:</p>

    <div class="form-group form-check">
      <div class="checkbox">
        <label>
          <input type="checkbox" value="" [ngModel]="showControlledPlants" (ngModelChange)="toggleShowPlants()">
          <span class="cr">
            <i class="cr-icon fa fa-check"> </i>
          </span>
          Mostrar Fábricas
        </label>
      </div>
    </div>

    <div class="form-group form-check">
      <div class="checkbox">
        <label>
          <input type="checkbox" value="" [ngModel]="showControlledSuppliers" (ngModelChange)="toggleShowSupplier()">
          <span class="cr">
            <i class="cr-icon fa fa-check"> </i>
          </span>
          Mostrar Fornecedores
        </label>
      </div>
    </div>

    <div class="form-group form-check">
      <div class="checkbox">
        <label>
          <input type="checkbox" value="" [ngModel]="showControlledLogistics" (ngModelChange)="toggleShowLogistic()">
          <span class="cr">
            <i class="cr-icon fa fa-check"> </i>
          </span>
          Mostrar Operadores Logísticos
        </label>
      </div>
    </div>
  </div>

  <!-- Mapa Geolocalização -->
  <div class="col-sm-12 col-md-9 m-mapa">
    <div id="map">
      <!-- [fullscreenControl]="true" -->
      <ngui-map [zoom]="zoom" [center]="center" (mapReady$)="onMapReady($event)">

        <!-- <marker *ngFor="let opt of options" [position]="opt.position" [title]="opt.name" (click)="clicked($event,opt)">
        </marker>
  
        <circle *ngFor="let circle of circles" [center]="circle.position" [visible]="true" [strokeColor]="'#6382c9'" [strokeOpacity]="0.5"
          [strokeWeight]="1" [radius]="this.auth.currentUser().radius">
        </circle> -->


        <!-- ///////////// -->
        <!-- Plant -->
        <marker *ngFor="let posPlants of listOfFactories" [position]="posPlants.position" (click)="clicked($event, posPlants)" [icon]="{ url: '../../../assets/images/pin_plant.png', size: [28, 43], scaledSize: [28, 43] }"
          [visible]="showControlledPlants">
        </marker>

        <circle *ngFor="let posPlantsRadius of listOfFactories" [center]="posPlantsRadius.latLng" [fillColor]="'#0044a8'" [fillOpacity]="0.2"
          [strokeColor]="'#0044a8'" [strokeOpacity]="0.4" [strokeWeight]="1" [visible]="showControlledPlants" radius="{{ settings.range_radius }}"></circle>


        <!-- ///////////// -->
        <!-- Logistic operator -->
        <marker *ngFor="let posLogistic of listOfLogistic" [position]="posLogistic.position" (click)="clicked($event, posLogistic)"
          [icon]="{ url: '../../../assets/images/pin_logistic.png', size: [28, 43], scaledSize: [28, 43] }" [visible]="showControlledLogistics">
        </marker>

        <circle *ngFor="let posLogisticRadius of listOfLogistic" [center]="posLogisticRadius.latLng" [fillColor]="'#4d4d4d'" [fillOpacity]="0.15"
          [strokeColor]="'#4d4d4d'" [strokeOpacity]="0.4" [strokeWeight]="1" [visible]="showControlledPlants" radius="{{ settings.range_radius }}"></circle>


        <!-- ///////////// -->
        <!-- Supplier -->
        <marker *ngFor="let posSuppliers of listOfSuppliers" [position]="posSuppliers.position" (click)="clicked($event, posSuppliers)"
          [icon]="{ url: '../../../assets/images/pin_supplier.png', size: [28, 43], scaledSize: [28, 43] }" [visible]="showControlledSuppliers">
        </marker>

        <circle *ngFor="let posSuppliersRadius of listOfSuppliers" [center]="posSuppliersRadius.latLng" [fillColor]="'#4d4d4d'" [fillOpacity]="0.2"
          [strokeColor]="'#4d4d4d'" [strokeOpacity]="0.4" [strokeWeight]="1" [visible]="showControlledPlants" radius="{{ settings.range_radius }}"></circle>


        <!-- ///////////// -->
        <!-- Embalagens -->
        <ng-container *ngFor="let pack of listPackings;">
          <marker *ngIf="(pack.accuracy <= accuracyRange) && (!showLastPosition)" [position]="pack.position" (click)="clicked($event,pack)"
            [icon]="getPinWithAlert(pack)">
            <!-- <info-window id="iw">
              <div class="iw-title">INFORMAÇÕES</div>
              <div *ngIf="marker.display" class="info-window-content">
                <p>
                  <span class="bold">Data de entrada:</span> {{ marker.start | date: 'dd/MM/yyyy - hh:mm a' }}</p>
                <p>
                  <span class="bold">Ultima visualização:</span> {{ marker.end ? (marker.end | date: 'dd/MM/yyyy - hh:mm a') : 'Sem Informação'}}</p>
                <p>
                  <span class="bold">Bateria:</span> {{ marker.battery | round }} %</p>
                <p>
                  <span class="bold">Acurácia:</span> {{ marker.accuracy || '-' }}m</p>
              </div>
            </info-window> -->
          </marker>
        </ng-container>

        <ng-container *ngFor="let posRadius of listPackings">
          <circle *ngIf="(posRadius.accuracy <= accuracyRange) && (!showLastPosition)" [center]="posRadius.latLng" [fillColor]="getRadiusWithAlert()"
            [fillOpacity]="0.2" [strokeColor]="getRadiusWithAlert()" [strokeOpacity]="0.7" [strokeWeight]="1" radius="{{ posRadius.accuracy || 0 }}"></circle>
        </ng-container>






















        <info-window id="iw" width="400" maxWidth="500">
          <div *ngIf="marker.display">
            <div>
              <div class="iw-title"> PLANTA {{marker.profile === "supplier" ? 'FORNECEDOR' : (marker.profile === "normal" ? 'FÁBRICA' : 'OP. LOGÍSTICO')}}
                {{marker.plant}} </div>

              <div>
                <div class="table-responsive tabela">
                  <table class="table" [hidden]="marker.nothing">
                    <thead>
                      <tr class="cabecalho" [hidden]="!marker.department">
                        <th>Setor/Área Interna</th>
                        <th class="teste">Opções</th>
                      </tr>
                      <tr class="cabecalho" [hidden]="!marker.packing">
                        <th>Embalagens na planta</th>
                        <th>Serial</th>

                      </tr>
                    </thead>
                    <tbody>

                      <tr [hidden]="!marker.department" *ngFor="let dept of marker.departments?.data | paginate: { id:'departmentmap', 
                                                                          itemsPerPage: marker.departments.meta.limit, 
                                                                          currentPage: marker.departments.meta.page, 
                                                                          totalItems:marker.departments.meta.total_docs}">
                        <td>{{dept.name}}</td>
                        <td class="teste2">
                          <button class="edit" (click)="open(dept._id)" type="button" name="button">Visualizar</button>
                        </td>
                      </tr>
                      <tr [hidden]="!marker.packing" *ngFor="let packing of marker.packings?.data | paginate: { id:'packingmap', 
                                                                                          itemsPerPage: marker.packings.meta.limit, 
                                                                                          currentPage:marker.packings.meta.page, 
                                                                                          totalItems:marker.packings.meta.total_docs}">
                        <td>{{packing.code}}</td>
                        <td>{{packing.serial}}</td>

                      </tr>

                    </tbody>
                  </table>

                  <div class="has-text-centered" [hidden]="!marker.department">
                    <pagination-controls id="departmentmap" (pageChange)="pageChangedDepart($event)" autoHide="true" directionLinks="false"></pagination-controls>
                  </div>

                  <div class="has-text-centered" [hidden]="!marker.packing">
                    <pagination-controls id="packingmap" (pageChange)="pageChangedPacking($event)" autoHide="true" directionLinks="false"></pagination-controls>
                  </div>

                  <div class="classVazio" [hidden]="!marker.nothing">
                    Não existe embalagens nessa planta.
                  </div>

                </div>
              </div>

            </div>
          </div>
        </info-window>
      </ngui-map>
    </div>
  </div>

</div>