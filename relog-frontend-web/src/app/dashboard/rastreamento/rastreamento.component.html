<div class="row no-gutters m-container">

  <ng-sidebar-container>
    <!-- Menu lateral -->
    <ng-sidebar [(opened)]="_opened" [closeOnClickOutside]="false" [autoFocus]="false">
      <div class="m-filtros">

        <!-- Sessão de Filtros -->
        <section>

          <button type="button" class="close noselect" aria-label="Close" (click)="_toggleSidebar()">
            <span aria-hidden="true">&times;</span>
          </button>

          <h6>Filtros:</h6>
          <div class="form-group">
            <label>Empresas vinculadas:</label>
            <ng-select [(ngModel)]="selectedCompany" [items]="listOfCompanies" (change)="companyChanged($event)" bindLabel="company.name"
              placeholder="Escolha um ponto de controle">
              <ng-template ng-label-tmp let-item="item">
                {{item.name}}
              </ng-template>
              <ng-template ng-option-tmp let-item="item">
                <div> {{item.name}} </div>
              </ng-template>
            </ng-select>
          </div>

          <div class="form-group">
            <label for="selectCode">Família</label>
            <ng-select id="selectCode" [(ngModel)]="selectedFamily" [items]="listOfFamilies" (clear)="onEquipmentSelectClear()"
              (change)="loadPackings(); loadSerialsOfSelectedEquipment()" bindLabel="code" placeholder="Selecione um Equipamento">
              <ng-template ng-label-tmp let-item="item">
                {{item.code}}
              </ng-template>
              <ng-template ng-option-tmp let-item="item">
                <div>
                  {{item.code}}
                </div>
              </ng-template>
            </ng-select>
          </div>

          <div class="form-group">
            <label>Serial</label>
            <ng-select [(ngModel)]="selectedSerial" (clear)="loadPackings()" (change)="loadPackings()" [items]="listOfSerials"
              bindLabel="serial" bindValue="serial" placeholder="Selecione um Serial" [disabled]="!selectedFamily">
              <ng-template ng-label-tmp let-item="item">
                {{item.serial}}
              </ng-template>
              <ng-template ng-option-tmp let-item="item">
                <div>{{ item.serial }}</div>
              </ng-template>
            </ng-select>
          </div>
        </section>


        <!-- Sessão de exibição -->
        <section>
          <p style="margin-top: 40px">Exibição:</p>

          <div class="form-group form-check">
            <div class="checkbox">
              <label>
                <input type="checkbox" value="" [ngModel]="showControlledPlants" (ngModelChange)="toggleShowPlants()">
                <span class="cr">
                  <i class="cr-icon fa fa-check"> </i>
                </span>
                Mostrar pontos de controle
              </label>
            </div>
          </div>

          <!-- <div class="form-group form-check">
            <div class="checkbox">
              <label>
                <input type="checkbox" value="" [ngModel]="showControlledSuppliers" (ngModelChange)="toggleShowSupplier()">
                <span class="cr">
                  <i class="cr-icon fa fa-check"> </i>
                </span>
                Mostrar Fornecedores
              </label>
            </div>
          </div>

          <div class="form-group form-check">
            <div class="checkbox">
              <label>
                <input type="checkbox" value="" [ngModel]="showControlledLogistics" (ngModelChange)="toggleShowLogistic()">
                <span class="cr">
                  <i class="cr-icon fa fa-check"> </i>
                </span>
                Mostrar Operadores Logísticos
              </label>
            </div>
          </div> -->

          <div class="form-group form-check">
            <div class="checkbox">
              <label>
                <input type="checkbox" value="" [ngModel]="showPackings" (ngModelChange)="toggleShowPackings()">
                <span class="cr">
                  <i class="cr-icon fa fa-check"> </i>
                </span>
                Mostrar Embalagens
              </label>
            </div>
          </div>
        </section>
      </div>
    </ng-sidebar>

    <!-- Mapa Geolocalização -->
    <div ng-sidebar-content>
      <div class="m-mapa">

        <!-- Botão da legenda dos ícones do mapa -->
        <button type="button" class="legend-button" [ngbPopover]="popContent" placement="bottom" triggers='hover'>
          <img width="20" height="20" src="data:image/svg+xml;base64,
            PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgNDM3LjYgNDM3LjYiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDQzNy42IDQzNy42OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGNsYXNzPSIiPjxnIHRyYW5zZm9ybT0ibWF0cml4KDEsIDAsIDAsIDEsIDAsIDApIj48Zz4KCTxnPgoJCTxnPgoJCQk8cGF0aCBkPSJNMTk0LDE0Mi44YzAuOCwxLjYsMS42LDMuMiwyLjQsNC40YzAuOCwxLjIsMiwyLjQsMi44LDMuNmMxLjIsMS4yLDIuNCwyLjQsNCwzLjZjMS4yLDAuOCwyLjgsMiw0LjgsMi40ICAgICBjMS42LDAuOCwzLjIsMS4yLDUuMiwxLjZjMiwwLjQsMy42LDAuNCw1LjIsMC40YzEuNiwwLDMuNiwwLDUuMi0wLjRjMS42LTAuNCwzLjItMC44LDQuNC0xLjZoMC40YzEuNi0wLjgsMy4yLTEuNiw0LjgtMi44ICAgICBjMS4yLTAuOCwyLjQtMiwzLjYtMy4ybDAuNC0wLjRjMS4yLTEuMiwyLTIuNCwyLjgtMy42czEuNi0yLjQsMi00YzAtMC40LDAtMC40LDAuNC0wLjhjMC44LTEuNiwxLjItMy42LDEuNi01LjIgICAgIGMwLjQtMS42LDAuNC0zLjYsMC40LTUuMnMwLTMuNi0wLjQtNS4yYy0wLjQtMS42LTAuOC0zLjItMS42LTUuMmMtMS4yLTIuOC0yLjgtNS4yLTQuOC03LjJjLTAuNC0wLjQtMC40LTAuNC0wLjgtMC44ICAgICBjLTEuMi0xLjItMi40LTItNC0zLjJjLTEuNi0wLjgtMi44LTEuNi00LjQtMi40Yy0xLjYtMC44LTMuMi0xLjItNC44LTEuNmMtMi0wLjQtMy42LTAuNC01LjItMC40Yy0xLjYsMC0zLjYsMC01LjIsMC40ICAgICBjLTEuNiwwLjQtMy4yLDAuOC00LjgsMS42SDIwOGMtMS42LDAuOC0zLjIsMS42LTQuNCwyLjRjLTEuNiwxLjItMi44LDItNCwzLjJjLTEuMiwxLjItMi40LDIuNC0zLjIsMy42ICAgICBjLTAuOCwxLjItMS42LDIuOC0yLjQsNC40Yy0wLjgsMS42LTEuMiwzLjItMS42LDQuOGMtMC40LDItMC40LDMuNi0wLjQsNS4yYzAsMS42LDAsMy42LDAuNCw1LjIgICAgIEMxOTIuOCwxMzkuNiwxOTMuNiwxNDEuMiwxOTQsMTQyLjh6IiBkYXRhLW9yaWdpbmFsPSIjMDAwMDAwIiBjbGFzcz0iYWN0aXZlLXBhdGgiIHN0eWxlPSJmaWxsOiM1NjU2NTYiIGRhdGEtb2xkX2NvbG9yPSIjNTc1NjU2Ij48L3BhdGg+CgkJCTxwYXRoIGQ9Ik0yNDkuNiwyODkuMmgtOS4ydi05OGMwLTUuNi00LjQtMTAuNC0xMC40LTEwLjRoLTQyYy01LjYsMC0xMC40LDQuNC0xMC40LDEwLjR2MjEuNmMwLDUuNiw0LjQsMTAuNCwxMC40LDEwLjRoOC40djY2LjQgICAgIEgxODhjLTUuNiwwLTEwLjQsNC40LTEwLjQsMTAuNHYyMS42YzAsNS42LDQuNCwxMC40LDEwLjQsMTAuNGg2MS42YzUuNiwwLDEwLjQtNC40LDEwLjQtMTAuNFYzMDAgICAgIEMyNjAsMjk0LDI1NS4yLDI4OS4yLDI0OS42LDI4OS4yeiIgZGF0YS1vcmlnaW5hbD0iIzAwMDAwMCIgY2xhc3M9ImFjdGl2ZS1wYXRoIiBzdHlsZT0iZmlsbDojNTY1NjU2IiBkYXRhLW9sZF9jb2xvcj0iIzU3NTY1NiI+PC9wYXRoPgoJCQk8cGF0aCBkPSJNMjE4LjgsMEM5OCwwLDAsOTgsMCwyMTguOHM5OCwyMTguOCwyMTguOCwyMTguOHMyMTguOC05OCwyMTguOC0yMTguOFMzMzkuNiwwLDIxOC44LDB6IE0yMTguOCw0MDguOCAgICAgYy0xMDQuOCwwLTE5MC04NS4yLTE5MC0xOTBzODUuMi0xOTAsMTkwLTE5MHMxOTAsODUuMiwxOTAsMTkwUzMyMy42LDQwOC44LDIxOC44LDQwOC44eiIgZGF0YS1vcmlnaW5hbD0iIzAwMDAwMCIgY2xhc3M9ImFjdGl2ZS1wYXRoIiBzdHlsZT0iZmlsbDojNTY1NjU2IiBkYXRhLW9sZF9jb2xvcj0iIzU3NTY1NiI+PC9wYXRoPgoJCTwvZz4KCTwvZz4KPC9nPjwvZz4gPC9zdmc+" />
        </button>

        <!-- Botão de filtros no mapa -->
        <button type="button" class="filter-button" (click)="_toggleSidebar()">
          Filtros
        </button>

        <!-- Balão da legenda dos ícones do mapa -->
        <ng-template #popContent>
          <!-- <p class="legend-title">LEGENDA:</p> -->
          <h5>Legenda:</h5>

          <ul class="list-unstyled legend-list">
            <li> <span style="background-color: #ef5562;"></span> Embalagem ausente</li>
            <li> <span style="background-color: #f77737;"></span> Local incorreto</li>
            <li> <span style="background-color: #f8bd37;"></span> Bateria baixa</li>
            <li> <span style="background-color: #4dc9ff;"></span> Embalagem atrasada</li>
            <li> <span style="background-color: #4c7bff;"></span> Tempo de permanência</li>
            <li> <span style="background-color: #9ecf99;"></span> Sem Sinal</li>
            <li> <span style="background-color: #3a9ca6;"></span> Perdida</li>
            <li> <span style="background-color: #027f01;"></span> Embalagens sem alerta</li>
            <li> <span style="background-color: #b39ddb;"></span> Embalagens agrupadas</li>
          </ul>
          <!-- <span class="lg6"></span><br /> -->
        </ng-template>

        <div id="map">

          <ngui-map [center]="center" [zoom]="4" [minZoom]="4" (mapReady$)="onInitMap($event)">

            <marker *ngFor="let opt of options" [position]="opt.position" [title]="opt.name" (click)="clicked($event,opt)">
            </marker>

            <circle *ngFor="let circle of circles" [center]="circle.position" [visible]="true" [strokeColor]="'#6382c9'"
              [strokeOpacity]="0.5" [strokeWeight]="1" [radius]="this.auth.currentUser().radius">
            </circle>


            <!-- ///////////// -->
            <!-- Control Point -->
            <!-- <marker *ngFor="let posCP of listOfControlPoints" [position]="posCP.position" [icon]="{ url: '../../../assets/images/pin_plant.png', size: [28, 43], scaledSize: [28, 43] }"
              [visible]="showControlledPlants" [title]="posCP.name" (click)="clicked($event, posCP)">
            </marker> -->

            <!-- <circle *ngFor="let posCPRadius of listOfControlPoints" [center]="posCPRadius.position" [fillColor]="'#0044a8'"
              [fillOpacity]="0.2" [strokeColor]="'#0044a8'" [strokeOpacity]="0.4" [strokeWeight]="1" [visible]="showControlledPlants"
              radius="{{ settings.range_radius }}"></circle> -->

            <!-- ######################## -->
            <!-- Marker para os polígonos -->
            <marker *ngFor="let posCP of listOfPolygonControlPoints" [position]="posCP.position" [icon]="{ url: 'assets/images/pin_plant.png', size: [28, 43], scaledSize: [28, 43] }"
              [visible]="showControlledPlants" [title]="posCP.name" (click)="clicked($event, posCP)"> </marker>

            <polygon *ngFor="let posCPPolygon of listOfPolygonControlPoints" [paths]="posCPPolygon.geofence.coordinates" [editable]="false" [fillColor]="'#0044a8'"
              [fillOpacity]="0.2" [strokeColor]="'#0044a8'" [strokeOpacity]="0.4" [strokeWeight]="1" [visible]="showControlledPlants"> </polygon>
            
            <!-- ######################## -->
            <!-- Marker para os círculos -->
            <marker *ngFor="let posCP of listOfCircleControlPoints" [position]="posCP.position" [icon]="{ url: 'assets/images/pin_plant.png', size: [28, 43], scaledSize: [28, 43] }"
              [visible]="showControlledPlants" [title]="posCP.name" (click)="clicked($event, posCP)"> </marker>

            <circle *ngFor="let posCPCircle of listOfCircleControlPoints" [center]="posCPCircle.geofence.coordinates[0]" [radius]="posCPCircle.geofence.radius"
              [editable]="false" [fillColor]="'#0044a8'" [fillOpacity]="0.2" [strokeColor]="'#0044a8'" [strokeOpacity]="0.4"
              [strokeWeight]="1" [visible]="showControlledPlants"> </circle>

            <!-- ######################## -->
            <!-- Infowindow de tabela -->
            <info-window id="iw" width="200" maxWidth="200">
              <div *ngIf="marker.display">
                <div class="iw-title"> {{marker.name}} </div>

                <div>
                  <div class="table-responsive tabela">
                    <table class="table">
                      <thead>
                        <tr class="cabecalho">
                          <th>Família</th>
                          <th>Serial</th>
                          <th>Tag</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let packing of packingsByPlant | paginate: { 
                                                                      id:'packingMap', 
                                                                      itemsPerPage: 10, 
                                                                      currentPage: packingsByPlantActualPage, 
                                                                      totalItems: packingsByPlant.length }">
                          <td>{{packing.family.code}}</td>
                          <td>{{packing.serial}}</td>
                          <td>{{packing.tag.code}}</td>
                        </tr>
                      </tbody>
                    </table>

                    <div class="has-text-centered">
                      <pagination-controls id="packingMap" (pageChange)="packingsByPlantActualPage = $event" autoHide="true"
                        directionLinks="false"></pagination-controls>
                    </div>

                    <div class="classVazio" *ngIf="packingsByPlant.length < 1">
                      Não existem embalagens nessa planta.
                    </div>

                  </div>
                </div>
              </div>
            </info-window>
          </ngui-map>
        </div>
      </div>
    </div>

  </ng-sidebar-container>
</div>